<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Панель администратора Humio</title>
  <style>
    :root {
      --bg-a: #f5f8ff;
      --bg-b: #ecfff8;
      --text: #102136;
      --muted: #4d647f;
      --border: rgba(16, 33, 54, 0.12);
      --danger: #9f1d1d;
      --primary: #102136;
      --panel-bg: rgba(255, 255, 255, 0.82);
      --ok: #0f7a3a;
      --warn: #8a5f08;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Segoe UI", Tahoma, sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 15% 15%, #dbe9ff 0%, transparent 40%),
        radial-gradient(circle at 90% 75%, #b9f2dc 0%, transparent 35%),
        linear-gradient(140deg, var(--bg-a), var(--bg-b));
    }

    .topbar {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
    }

    .topbar-title {
      margin: 0;
      font-size: 28px;
      line-height: 1.2;
    }

    .topbar-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--muted);
    }

    .logout-button {
      border: 1px solid #ef4444;
      background: #fff;
      color: var(--danger);
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
    }

    .content {
      padding: 24px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 10px;
    }

    .tab-button {
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      border-radius: 10px;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
    }

    .tab-button.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    .tab-panel {
      display: none;
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px;
    }

    .tab-panel.active {
      display: block;
    }

    .promo-layout {
      display: grid;
      grid-template-columns: minmax(280px, 380px) 1fr;
      gap: 16px;
    }

    .promo-card {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 10px;
      padding: 14px;
    }

    .promo-card h3 {
      margin: 0 0 12px;
      font-size: 17px;
    }

    .field {
      display: grid;
      gap: 6px;
      margin-bottom: 10px;
    }

    .field label {
      font-size: 13px;
      color: var(--muted);
    }

    .field input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
    }

    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .btn {
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      border-radius: 8px;
      padding: 7px 12px;
      cursor: pointer;
      font-size: 13px;
    }

    .btn.primary {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }

    .btn.danger {
      border-color: #ef4444;
      color: var(--danger);
      background: #fff;
    }

    .promo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .promo-search {
      display: flex;
      gap: 8px;
      width: 100%;
      max-width: 420px;
    }

    .promo-search input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
    }

    .promo-table-wrap {
      overflow-x: auto;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
    }

    .promo-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 840px;
    }

    .modules-table {
      min-width: 620px;
    }

    .modules-table th:first-child,
    .modules-table td:first-child {
      width: 84px;
      white-space: nowrap;
    }

    .promo-table th,
    .promo-table td {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 14px;
      vertical-align: top;
    }

    .promo-table th {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: var(--muted);
      background: #f8fbff;
    }

    .promo-table tr:last-child td {
      border-bottom: none;
    }

    .row-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .icon-btn {
      width: 30px;
      height: 30px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      border-radius: 8px;
    }

    .icon-btn img {
      width: 16px;
      height: 16px;
      display: block;
    }

    .status {
      margin-top: 10px;
      font-size: 13px;
      color: var(--muted);
      min-height: 18px;
    }

    .status.error {
      color: var(--danger);
    }

    .status.ok {
      color: var(--ok);
    }

    .hint {
      margin-top: 4px;
      font-size: 12px;
      color: var(--warn);
    }

    .modules-shell {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 320px;
      gap: 12px;
      align-items: start;
    }

    .modules-left {
      display: grid;
      gap: 10px;
    }

    .modules-right {
      display: grid;
      gap: 10px;
    }

    .modules-panel .promo-card {
      padding: 10px;
    }

    .modules-panel .promo-card h3 {
      margin-bottom: 8px;
      font-size: 15px;
    }

    .modules-panel .field {
      margin-bottom: 8px;
      gap: 4px;
    }

    .modules-panel .field label {
      font-size: 12px;
    }

    .modules-panel .field input {
      padding: 6px 8px;
      font-size: 13px;
    }

    .modules-panel .btn {
      padding: 6px 10px;
      font-size: 12px;
    }

    .modules-tables {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .modules-panel .promo-table {
      min-width: 480px;
    }

    @media (max-width: 980px) {
      .promo-layout {
        grid-template-columns: 1fr;
      }

      .modules-shell { grid-template-columns: 1fr; }

      .modules-tables {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <h1 class="topbar-title">Панель администратора Humio</h1>
    <div class="topbar-actions">
      <span id="user-name" class="user-name">Пользователь</span>
      <button id="logout-button" class="logout-button" type="button">Выйти</button>
    </div>
  </header>

  <main class="content">
    <nav class="tabs" aria-label="Разделы панели">
      <button class="tab-button active" type="button" data-tab="users">Пользователи</button>
      <button class="tab-button" type="button" data-tab="promocodes">Промокоды</button>
      <button class="tab-button" type="button" data-tab="modules">Модули</button>
    </nav>

    <section id="tab-users" class="tab-panel active">
      <h2>Пользователи</h2>
    </section>

    <section id="tab-promocodes" class="tab-panel">
      <div class="promo-layout">
        <div class="promo-card">
          <h3 id="promo-form-title">Создать промокод</h3>
          <form id="promo-form">
            <input id="promo-edit-id" type="hidden" />
            <div class="field">
              <label for="promo-code">Код</label>
              <input id="promo-code" type="text" required placeholder="WELCOME10" />
            </div>
            <div class="field">
              <label for="promo-max-usage">Макс. использований</label>
              <input id="promo-max-usage" type="number" min="1" required placeholder="100" />
            </div>
            <div class="field">
              <label for="promo-days">Дней действия</label>
              <input id="promo-days" type="number" min="1" required placeholder="30" />
            </div>
            <div class="field">
              <label for="promo-product-id">ID продукта (product_set)</label>
              <input id="promo-product-id" type="number" min="1" required placeholder="1" />
            </div>
            <div class="buttons">
              <button class="btn primary" type="submit" id="promo-submit-btn">Создать</button>
              <button class="btn" type="button" id="promo-cancel-btn" hidden>Отмена</button>
            </div>
          </form>
          <div id="promo-form-status" class="status"></div>
          <div class="hint">Дата "Действует до" вычисляется как сегодня + "Дней действия".</div>
        </div>

        <div class="promo-card">
          <div class="promo-header">
            <h3>Список промокодов</h3>
            <div class="promo-search">
              <input id="promo-search-code" type="text" placeholder="Поиск по коду" />
              <button class="btn" id="promo-search-btn" type="button">Найти</button>
              <button class="btn" id="promo-reset-btn" type="button">Сброс</button>
            </div>
          </div>
          <div class="promo-table-wrap">
            <table class="promo-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Код</th>
                  <th>Макс. использ.</th>
                  <th>Дней</th>
                  <th>Действует до (расчетно)</th>
                  <th>Product ID</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody id="promo-table-body"></tbody>
            </table>
          </div>
          <div id="promo-list-status" class="status"></div>
        </div>
      </div>
    </section>

    <section id="tab-modules" class="tab-panel modules-panel">
      <div class="modules-shell">
        <div class="modules-left">
          <div class="modules-tables">
            <div class="promo-card">
              <div class="promo-header">
                <h3>Таблица модулей</h3>
              </div>
              <div class="promo-table-wrap">
                <table class="promo-table modules-table">
                  <thead>
                <tr>
                  <th>ID</th>
                  <th>Название</th>
                  <th>Описание</th>
                  <th>Действия</th>
                </tr>
                  </thead>
                  <tbody id="modules-table-body"></tbody>
                </table>
              </div>
              <div id="modules-list-status" class="status"></div>
            </div>

            <div class="promo-card">
              <div class="promo-header">
                <h3>Таблица продуктов</h3>
              </div>
              <div class="promo-table-wrap">
                <table class="promo-table modules-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Название</th>
                      <th>Module IDs</th>
                    </tr>
                  </thead>
                  <tbody id="products-table-body"></tbody>
                </table>
              </div>
              <div id="products-list-status" class="status"></div>
            </div>
          </div>
        </div>

        <div class="modules-right">
          <div class="promo-card">
            <h3 id="module-form-title">Создать модуль</h3>
            <form id="module-form">
              <input id="module-edit-id" type="hidden" />
              <div class="field">
                <label for="module-name">Название модуля</label>
                <input id="module-name" type="text" required placeholder="Базовый курс" />
              </div>
              <div class="field">
                <label for="module-description">Описание</label>
                <input id="module-description" type="text" placeholder="Краткое описание" />
              </div>
              <div id="module-locale-box" class="field" hidden>
                <label for="module-locale-code">Локализация</label>
                <div class="buttons" style="margin-top:0;">
                  <select id="module-locale-code" style="padding: 6px 8px; border-radius: 8px; border: 1px solid var(--border); font-size: 13px;">
                    <option value="en">EN</option>
                  </select>
                </div>
                <input id="module-locale-name" type="text" placeholder="Название на выбранном языке" />
                <input id="module-locale-description" type="text" placeholder="Описание на выбранном языке" />
                <div id="module-locale-status" class="status"></div>
              </div>
              <div class="buttons">
                <button class="btn primary" type="submit" id="module-submit-btn">Создать модуль</button>
                <button class="btn" type="button" id="module-cancel-btn" hidden>Отмена</button>
              </div>
            </form>
            <div id="module-form-status" class="status"></div>
          </div>

          <div class="promo-card">
            <h3>Создать продукт</h3>
            <form id="product-form">
              <div class="field">
                <label for="product-name">Название продукта</label>
                <input id="product-name" type="text" required placeholder="Премиум доступ" />
              </div>
              <div class="field">
                <label for="product-module-select">Модуль</label>
                <div class="buttons" style="margin-top:0;">
                  <select id="product-module-select" style="flex:1; min-width: 0; padding: 6px 8px; border-radius: 8px; border: 1px solid var(--border); font-size: 13px;"></select>
                </div>
              </div>
              <div class="field">
                <label>Выбранные модули</label>
                <div id="product-modules-selected" class="hint">Пока не выбрано ни одного модуля.</div>
              </div>
              <div class="buttons">
                <button class="btn primary" type="submit">Создать продукт</button>
              </div>
            </form>
            <div id="product-form-status" class="status"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const userName = document.getElementById("user-name");
    const logoutButton = document.getElementById("logout-button");
    const tabButtons = Array.from(document.querySelectorAll(".tab-button"));
    const tabPanels = Array.from(document.querySelectorAll(".tab-panel"));

    const promoForm = document.getElementById("promo-form");
    const promoFormTitle = document.getElementById("promo-form-title");
    const promoSubmitBtn = document.getElementById("promo-submit-btn");
    const promoCancelBtn = document.getElementById("promo-cancel-btn");
    const promoEditId = document.getElementById("promo-edit-id");
    const promoCodeInput = document.getElementById("promo-code");
    const promoMaxUsageInput = document.getElementById("promo-max-usage");
    const promoDaysInput = document.getElementById("promo-days");
    const promoProductIdInput = document.getElementById("promo-product-id");
    const promoFormStatus = document.getElementById("promo-form-status");

    const promoTableBody = document.getElementById("promo-table-body");
    const promoListStatus = document.getElementById("promo-list-status");
    const promoSearchCode = document.getElementById("promo-search-code");
    const promoSearchBtn = document.getElementById("promo-search-btn");
    const promoResetBtn = document.getElementById("promo-reset-btn");

    const moduleForm = document.getElementById("module-form");
    const moduleFormTitle = document.getElementById("module-form-title");
    const moduleEditId = document.getElementById("module-edit-id");
    const moduleNameInput = document.getElementById("module-name");
    const moduleDescriptionInput = document.getElementById("module-description");
    const moduleLocaleBox = document.getElementById("module-locale-box");
    const moduleLocaleCode = document.getElementById("module-locale-code");
    const moduleLocaleName = document.getElementById("module-locale-name");
    const moduleLocaleDescription = document.getElementById("module-locale-description");
    const moduleLocaleStatus = document.getElementById("module-locale-status");
    const moduleSubmitBtn = document.getElementById("module-submit-btn");
    const moduleCancelBtn = document.getElementById("module-cancel-btn");
    const moduleFormStatus = document.getElementById("module-form-status");

    const productForm = document.getElementById("product-form");
    const productNameInput = document.getElementById("product-name");
    const productModuleSelect = document.getElementById("product-module-select");
    const productModulesSelected = document.getElementById("product-modules-selected");
    const productFormStatus = document.getElementById("product-form-status");

    const modulesTableBody = document.getElementById("modules-table-body");
    const modulesListStatus = document.getElementById("modules-list-status");
    const productsTableBody = document.getElementById("products-table-body");
    const productsListStatus = document.getElementById("products-list-status");

    let promoItems = [];
    let moduleItems = [];
    let productItems = [];
    let selectedProductModuleIds = [];

    function resetModuleForm() {
      moduleEditId.value = "";
      moduleNameInput.value = "";
      moduleDescriptionInput.value = "";
      moduleLocaleBox.hidden = true;
      moduleLocaleCode.value = "en";
      moduleLocaleName.value = "";
      moduleLocaleDescription.value = "";
      setStatus(moduleLocaleStatus, "", null);
      moduleFormTitle.textContent = "Создать модуль";
      moduleSubmitBtn.textContent = "Создать модуль";
      moduleCancelBtn.hidden = true;
      setStatus(moduleFormStatus, "", null);
    }

    function fillModuleForm(item) {
      moduleEditId.value = String(item.id);
      moduleNameInput.value = item.name;
      moduleDescriptionInput.value = item.description || "";
      moduleLocaleBox.hidden = false;
      moduleFormTitle.textContent = `Редактировать модуль #${item.id}`;
      moduleSubmitBtn.textContent = "Сохранить";
      moduleCancelBtn.hidden = false;
      setStatus(moduleFormStatus, "", null);
      moduleNameInput.focus();
      loadModuleLocalization();
    }

    async function loadModuleLocalization() {
      const moduleId = Number(moduleEditId.value);
      const languageCode = moduleLocaleCode.value;
      if (!moduleId || !languageCode) {
        return;
      }

      setStatus(moduleLocaleStatus, "Загрузка локализации...", null);
      moduleLocaleName.value = "";
      moduleLocaleDescription.value = "";

      try {
        const { res, data } = await requestJson(`/api/modules/${moduleId}/localizations?languageCode=${encodeURIComponent(languageCode)}`, {
          method: "GET",
          headers: getAuthHeaders()
        });

        if (res.status === 404) {
          setStatus(moduleLocaleStatus, "Для выбранного языка локализация не заполнена.", null);
          return;
        }

        if (!res.ok) {
          throw new Error(getErrorText(data, "Не удалось загрузить локализацию."));
        }

        moduleLocaleName.value = data?.name || "";
        moduleLocaleDescription.value = data?.description || "";
        setStatus(moduleLocaleStatus, "Локализация загружена.", "ok");
      } catch (error) {
        setStatus(moduleLocaleStatus, error.message || "Ошибка загрузки локализации.", "error");
      }
    }

    function renderSelectedProductModules() {
      if (selectedProductModuleIds.length === 0) {
        productModulesSelected.innerHTML = "Пока не выбрано ни одного модуля.";
        return;
      }

      const byId = new Map(moduleItems.map((item) => [item.id, item.name]));
      productModulesSelected.innerHTML = selectedProductModuleIds
        .map((id) => {
          const name = byId.get(id) || `ID ${id}`;
          return `<span style="display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:4px 8px;margin:0 6px 6px 0;background:#fff;">
            <span>${name}</span>
            <button type="button" class="btn danger" data-remove-module-id="${id}" style="padding:2px 7px;line-height:1;">×</button>
          </span>`;
        })
        .join("");
    }

    function populateProductModuleSelect() {
      if (!moduleItems.length) {
        productModuleSelect.innerHTML = `<option value="">Нет модулей</option>`;
        return;
      }

      productModuleSelect.innerHTML = [`<option value="" selected>Выберите модуль</option>`]
        .concat(moduleItems.map((module) => `<option value="${module.id}">${module.name}</option>`))
        .join("");
    }

    function getCurrentUser() {
      const raw = localStorage.getItem("currentUser");
      if (!raw) {
        return null;
      }

      try {
        return JSON.parse(raw);
      } catch {
        return null;
      }
    }

    function getAuthHeaders() {
      const accessToken = localStorage.getItem("accessToken");
      const headers = { "Content-Type": "application/json" };
      if (accessToken) {
        headers.Authorization = `Bearer ${accessToken}`;
      }
      return headers;
    }

    function formatDate(value) {
      return value.toLocaleDateString("ru-RU", { year: "numeric", month: "2-digit", day: "2-digit" });
    }

    function calcValidTo(days) {
      const date = new Date();
      date.setDate(date.getDate() + Number(days || 0));
      return formatDate(date);
    }

    function setStatus(el, text, mode) {
      el.textContent = text || "";
      el.classList.remove("error", "ok");
      if (mode) {
        el.classList.add(mode);
      }
    }

    function getErrorText(payload, fallback) {
      if (payload && Array.isArray(payload.errors) && payload.errors.length > 0) {
        return payload.errors.join(" ");
      }
      return fallback;
    }

    async function requestJson(url, options) {
      const res = await fetch(url, options);
      let data = null;
      try {
        data = await res.json();
      } catch {
      }
      return { res, data };
    }

    function resetPromoForm() {
      promoEditId.value = "";
      promoCodeInput.value = "";
      promoMaxUsageInput.value = "";
      promoDaysInput.value = "";
      promoProductIdInput.value = "";
      promoFormTitle.textContent = "Создать промокод";
      promoSubmitBtn.textContent = "Создать";
      promoCancelBtn.hidden = true;
      setStatus(promoFormStatus, "", null);
    }

    function fillPromoForm(item) {
      promoEditId.value = String(item.id);
      promoCodeInput.value = item.code;
      promoMaxUsageInput.value = String(item.maxUsageCount);
      promoDaysInput.value = String(item.days);
      promoProductIdInput.value = String(item.productId);
      promoFormTitle.textContent = `Редактировать промокод #${item.id}`;
      promoSubmitBtn.textContent = "Сохранить";
      promoCancelBtn.hidden = false;
      setStatus(promoFormStatus, "", null);
      promoCodeInput.focus();
    }

    function renderPromocodes(items) {
      if (!items || items.length === 0) {
        promoTableBody.innerHTML = `<tr><td colspan="7">Промокодов пока нет.</td></tr>`;
        return;
      }

      promoTableBody.innerHTML = items.map((item) => {
        const validTo = calcValidTo(item.days);
        return `
          <tr>
            <td>${item.id}</td>
            <td><strong>${item.code}</strong></td>
            <td>${item.maxUsageCount}</td>
            <td>${item.days}</td>
            <td>${validTo}</td>
            <td>${item.productId}</td>
            <td>
              <div class="row-actions">
                <button class="btn icon-btn" type="button" data-action="edit" data-id="${item.id}" title="Редактировать" aria-label="Редактировать">
                  <img src="/icons/edit_pen.svg" alt="" />
                </button>
                <button class="btn danger icon-btn" type="button" data-action="delete" data-id="${item.id}" title="Удалить" aria-label="Удалить">
                  <img src="/icons/delete_cross.svg" alt="" />
                </button>
              </div>
            </td>
          </tr>`;
      }).join("");
    }

    async function loadPromocodes() {
      setStatus(promoListStatus, "Загрузка списка...", null);
      try {
        const { res, data } = await requestJson("/api/promocodes?skip=0&take=100", {
          method: "GET",
          headers: getAuthHeaders()
        });

        if (!res.ok) {
          throw new Error(getErrorText(data, "Не удалось загрузить промокоды."));
        }

        promoItems = Array.isArray(data?.items) ? data.items : [];
        renderPromocodes(promoItems);
        setStatus(promoListStatus, `Всего: ${data?.total ?? promoItems.length}`, "ok");
      } catch (error) {
        renderPromocodes([]);
        setStatus(promoListStatus, error.message || "Ошибка загрузки.", "error");
      }
    }

    async function searchByCode() {
      const code = promoSearchCode.value.trim();
      if (!code) {
        loadPromocodes();
        return;
      }

      setStatus(promoListStatus, "Поиск...", null);
      try {
        const { res, data } = await requestJson(`/api/promocodes/by-code?code=${encodeURIComponent(code)}`, {
          method: "GET",
          headers: getAuthHeaders()
        });

        if (res.status === 404) {
          renderPromocodes([]);
          setStatus(promoListStatus, "Промокод не найден.", "error");
          return;
        }

        if (!res.ok) {
          throw new Error(getErrorText(data, "Не удалось выполнить поиск."));
        }

        renderPromocodes([data]);
        setStatus(promoListStatus, "Найден 1 промокод.", "ok");
      } catch (error) {
        renderPromocodes([]);
        setStatus(promoListStatus, error.message || "Ошибка поиска.", "error");
      }
    }

    async function deletePromocode(id) {
      if (!confirm(`Удалить промокод #${id}?`)) {
        return;
      }

      setStatus(promoListStatus, "Удаление...", null);
      try {
        const { res, data } = await requestJson(`/api/promocodes/${id}`, {
          method: "DELETE",
          headers: getAuthHeaders()
        });

        if (!res.ok && res.status !== 204) {
          throw new Error(getErrorText(data, "Не удалось удалить промокод."));
        }

        setStatus(promoListStatus, `Промокод #${id} удален.`, "ok");
        if (promoEditId.value === String(id)) {
          resetPromoForm();
        }
        await loadPromocodes();
      } catch (error) {
        setStatus(promoListStatus, error.message || "Ошибка удаления.", "error");
      }
    }

    async function submitPromoForm(event) {
      event.preventDefault();
      setStatus(promoFormStatus, "", null);

      const payload = {
        code: promoCodeInput.value.trim(),
        maxUsageCount: Number(promoMaxUsageInput.value),
        days: Number(promoDaysInput.value),
        productId: Number(promoProductIdInput.value)
      };

      if (!payload.code || payload.maxUsageCount < 1 || payload.days < 1 || payload.productId < 1) {
        setStatus(promoFormStatus, "Проверьте введенные значения.", "error");
        return;
      }

      const editId = promoEditId.value.trim();
      const isEdit = editId.length > 0;

      try {
        setStatus(promoFormStatus, isEdit ? "Сохранение..." : "Создание...", null);

        const { res, data } = await requestJson(isEdit ? `/api/promocodes/${editId}` : "/api/promocodes", {
          method: isEdit ? "PATCH" : "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error(getErrorText(data, isEdit ? "Не удалось сохранить промокод." : "Не удалось создать промокод."));
        }

        setStatus(promoFormStatus, isEdit ? "Изменения сохранены." : "Промокод создан.", "ok");
        resetPromoForm();
        await loadPromocodes();
      } catch (error) {
        setStatus(promoFormStatus, error.message || "Ошибка запроса.", "error");
      }
    }

    function renderModules(items) {
      if (!items || items.length === 0) {
        modulesTableBody.innerHTML = `<tr><td colspan="4">Модулей пока нет.</td></tr>`;
        return;
      }

      modulesTableBody.innerHTML = items.map((item) => `
          <tr>
            <td>${item.id}</td>
            <td><strong>${item.name}</strong></td>
            <td>${item.description || "—"}</td>
            <td>
              <div class="row-actions">
                <button class="btn icon-btn" type="button" data-module-action="edit" data-id="${item.id}" title="Редактировать" aria-label="Редактировать">
                  <img src="/icons/edit_pen.svg" alt="" />
                </button>
                <button class="btn danger icon-btn" type="button" data-module-action="delete" data-id="${item.id}" title="Удалить" aria-label="Удалить">
                  <img src="/icons/delete_cross.svg" alt="" />
                </button>
              </div>
            </td>
          </tr>`).join("");
    }

    function renderProducts(items) {
      if (!items || items.length === 0) {
        productsTableBody.innerHTML = `<tr><td colspan="3">Продуктов пока нет.</td></tr>`;
        return;
      }

      productsTableBody.innerHTML = items.map((item) => {
        const moduleIds = Array.isArray(item.moduleIds) && item.moduleIds.length > 0
          ? item.moduleIds.join(", ")
          : "—";

        return `
          <tr>
            <td>${item.id}</td>
            <td><strong>${item.name}</strong></td>
            <td>${moduleIds}</td>
          </tr>`;
      }).join("");
    }

    async function loadModules() {
      setStatus(modulesListStatus, "Загрузка модулей...", null);
      try {
        const { res, data } = await requestJson("/api/modules", {
          method: "GET",
          headers: getAuthHeaders()
        });

        if (!res.ok) {
          throw new Error(getErrorText(data, "Не удалось загрузить модули."));
        }

        moduleItems = Array.isArray(data) ? data : [];
        selectedProductModuleIds = selectedProductModuleIds.filter((id) => moduleItems.some((m) => m.id === id));
        populateProductModuleSelect();
        renderSelectedProductModules();

        const productMap = new Map();
        moduleItems.forEach((module) => {
          const products = Array.isArray(module.products) ? module.products : [];
          products.forEach((product) => {
            productMap.set(product.id, product);
          });
        });
        productItems = Array.from(productMap.values()).sort((a, b) => a.id - b.id);

        renderModules(moduleItems);
        renderProducts(productItems);
        setStatus(modulesListStatus, `Всего модулей: ${moduleItems.length}`, "ok");
        setStatus(productsListStatus, `Всего продуктов: ${productItems.length}`, "ok");
      } catch (error) {
        renderModules([]);
        renderProducts([]);
        setStatus(modulesListStatus, error.message || "Ошибка загрузки модулей.", "error");
        setStatus(productsListStatus, "", null);
      }
    }

    async function submitModuleForm(event) {
      event.preventDefault();
      setStatus(moduleFormStatus, "", null);
      const editId = moduleEditId.value.trim();
      const isEdit = editId.length > 0;

      const payload = {
        name: moduleNameInput.value.trim(),
        description: moduleDescriptionInput.value.trim() || null
      };

      if (!payload.name) {
        setStatus(moduleFormStatus, "Проверьте введенные значения.", "error");
        return;
      }

      try {
        setStatus(moduleFormStatus, isEdit ? "Сохранение..." : "Создание модуля...", null);
        const { res, data } = await requestJson(isEdit ? `/api/modules/${editId}` : "/api/modules", {
          method: isEdit ? "PATCH" : "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error(getErrorText(data, "Не удалось создать модуль."));
        }

        if (isEdit && moduleLocaleBox.hidden === false) {
          const localeName = moduleLocaleName.value.trim();
          if (localeName.length > 0) {
            const localizationPayload = {
              languageCode: moduleLocaleCode.value,
              name: localeName,
              description: moduleLocaleDescription.value.trim() || null
            };

            const { res: localeRes, data: localeData } = await requestJson(`/api/modules/${editId}/localizations`, {
              method: "PUT",
              headers: getAuthHeaders(),
              body: JSON.stringify(localizationPayload)
            });

            if (!localeRes.ok) {
              throw new Error(getErrorText(localeData, "Модуль сохранен, но локализация не сохранилась."));
            }
          }
        }

        resetModuleForm();
        setStatus(moduleFormStatus, isEdit ? "Модуль обновлен." : "Модуль создан.", "ok");
        await loadModules();
      } catch (error) {
        setStatus(moduleFormStatus, error.message || "Ошибка сохранения модуля.", "error");
      }
    }

    async function deleteModule(id) {
      if (!confirm(`Удалить модуль #${id}?`)) {
        return;
      }

      setStatus(modulesListStatus, "Удаление модуля...", null);
      try {
        const { res, data } = await requestJson(`/api/modules/${id}`, {
          method: "DELETE",
          headers: getAuthHeaders()
        });

        if (!res.ok && res.status !== 204) {
          throw new Error(getErrorText(data, "Не удалось удалить модуль."));
        }

        if (moduleEditId.value === String(id)) {
          resetModuleForm();
        }

        setStatus(modulesListStatus, `Модуль #${id} удален.`, "ok");
        await loadModules();
      } catch (error) {
        setStatus(modulesListStatus, error.message || "Ошибка удаления модуля.", "error");
      }
    }

    async function submitProductForm(event) {
      event.preventDefault();
      setStatus(productFormStatus, "", null);

      const payload = {
        name: productNameInput.value.trim(),
        moduleIds: selectedProductModuleIds
      };

      if (!payload.name || payload.moduleIds.length === 0) {
        setStatus(productFormStatus, "Проверьте введенные значения.", "error");
        return;
      }

      try {
        setStatus(productFormStatus, "Создание продукта...", null);
        const { res, data } = await requestJson("/api/modules/products", {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          throw new Error(getErrorText(data, "Не удалось создать продукт."));
        }

        productForm.reset();
        selectedProductModuleIds = [];
        renderSelectedProductModules();
        setStatus(productFormStatus, "Продукт создан.", "ok");
        await loadModules();
      } catch (error) {
        setStatus(productFormStatus, error.message || "Ошибка создания продукта.", "error");
      }
    }

    async function logout() {
      const refreshToken = localStorage.getItem("refreshToken");

      if (refreshToken) {
        try {
          await fetch("/api/auth/logout", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ refreshToken })
          });
        } catch {
        }
      }

      localStorage.removeItem("accessToken");
      localStorage.removeItem("refreshToken");
      localStorage.removeItem("accessTokenExpiresAt");
      localStorage.removeItem("currentUser");
      window.location.href = "/register.html";
    }

    const accessToken = localStorage.getItem("accessToken");
    if (!accessToken) {
      window.location.href = "/register.html";
    }

    const user = getCurrentUser();
    const displayName = user?.name || user?.email || "Пользователь";
    userName.textContent = displayName;

    tabButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const tab = button.dataset.tab;

        tabButtons.forEach((item) => {
          item.classList.toggle("active", item === button);
        });

        tabPanels.forEach((panel) => {
          panel.classList.toggle("active", panel.id === `tab-${tab}`);
        });

        if (tab === "promocodes" && promoItems.length === 0) {
          loadPromocodes();
        }

        if (tab === "modules" && moduleItems.length === 0) {
          loadModules();
        }
      });
    });

    promoForm.addEventListener("submit", submitPromoForm);
    moduleForm.addEventListener("submit", submitModuleForm);
    productForm.addEventListener("submit", submitProductForm);
    moduleCancelBtn.addEventListener("click", resetModuleForm);
    moduleLocaleCode.addEventListener("change", loadModuleLocalization);

    promoCancelBtn.addEventListener("click", () => {
      resetPromoForm();
    });

    promoSearchBtn.addEventListener("click", searchByCode);
    promoResetBtn.addEventListener("click", () => {
      promoSearchCode.value = "";
      loadPromocodes();
    });

    productModuleSelect.addEventListener("change", () => {
      const id = Number(productModuleSelect.value);
      if (!id) {
        return;
      }

      if (!selectedProductModuleIds.includes(id)) {
        selectedProductModuleIds.push(id);
        renderSelectedProductModules();
      }
    });

    promoSearchCode.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        searchByCode();
      }
    });

    promoTableBody.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) {
        return;
      }

      const button = target.closest("button[data-action]");
      if (!(button instanceof HTMLButtonElement)) {
        return;
      }

      const action = button.dataset.action;
      const id = Number(button.dataset.id);
      if (!action || !id) {
        return;
      }

      const item = promoItems.find((x) => x.id === id);
      if (!item) {
        return;
      }

      if (action === "edit") {
        fillPromoForm(item);
      } else if (action === "delete") {
        deletePromocode(id);
      }
    });

    modulesTableBody.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) {
        return;
      }

      const button = target.closest("button[data-module-action]");
      if (!(button instanceof HTMLButtonElement)) {
        return;
      }

      const action = button.dataset.moduleAction;
      const id = Number(button.dataset.id);
      if (!action || !id) {
        return;
      }

      const item = moduleItems.find((x) => x.id === id);
      if (!item) {
        return;
      }

      if (action === "edit") {
        fillModuleForm(item);
      } else if (action === "delete") {
        deleteModule(id);
      }
    });

    productModulesSelected.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) {
        return;
      }

      const removeId = Number(target.dataset.removeModuleId);
      if (!removeId) {
        return;
      }

      selectedProductModuleIds = selectedProductModuleIds.filter((id) => id !== removeId);
      renderSelectedProductModules();
    });

    logoutButton.addEventListener("click", logout);
  </script>
</body>
</html>
